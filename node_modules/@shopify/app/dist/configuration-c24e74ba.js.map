{"version":3,"file":"configuration-c24e74ba.js","sources":["../src/cli/utilities/extensions/configuration.ts"],"sourcesContent":["import {nodeExtensionsCLIPath} from './cli'\nimport {App, UIExtension, getUIExtensionRendererVersion} from '../../models/app/app'\nimport {UIExtensionTypes} from '../../constants'\nimport {error, path} from '@shopify/cli-kit'\n\nconst RendererNotFoundBug = (extension: string) => {\n  return new error.Bug(\n    `Couldn't find renderer version for extension ${extension}`,\n    'Make sure you have all your dependencies up to date',\n  )\n}\nexport interface ExtensionConfigOptions {\n  app: App\n  apiKey?: string\n  extensions: UIExtension[]\n  buildDirectory?: string\n  url?: string\n  port?: number\n  storeFqdn?: string\n  includeResourceURL?: boolean\n  cartUrl?: string\n  subscriptionProductUrl?: string\n}\n\n/**\n * The extensions' Go binary receives the configuration through\n * standard input as a YAML-encoded object. This function returns the\n * Javascript object representing the configuration necessary for building.\n * @param extension {UIExtension} Extension that will be built.\n * @returns\n */\nexport async function extensionConfig(options: ExtensionConfigOptions): Promise<unknown> {\n  const extensionsConfig = await Promise.all(\n    options.extensions.map(async (extension) => {\n      const renderer = await getUIExtensionRendererVersion(extension.configuration.type, options.app)\n      if (renderer === 'not_found') throw RendererNotFoundBug(extension.configuration.type)\n      return {\n        uuid: extension.devUUID,\n        title: extension.configuration.name,\n        type: `${extension.configuration.type}`,\n        metafields: extension.configuration.metafields,\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        extension_points: extension.configuration.extensionPoints || [],\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        node_executable: await nodeExtensionsCLIPath(),\n        surface: getUIExtensionSurface(extension.configuration.type),\n        version: renderer?.version,\n        development: {\n          // eslint-disable-next-line @typescript-eslint/naming-convention\n          root_dir: path.relative(options.app.directory, extension.directory),\n          // eslint-disable-next-line @typescript-eslint/naming-convention\n          build_dir: options.buildDirectory\n            ? path.relative(extension.directory, options.buildDirectory)\n            : path.relative(extension.directory, extension.buildDirectory),\n          entries: {\n            main: path.relative(extension.directory, extension.entrySourceFilePath),\n          },\n          renderer,\n          resource: options.includeResourceURL\n            ? await getUIExtensionResourceURL(extension.configuration.type, options)\n            : null,\n          build: {\n            env: options.app.dotenv?.variables ?? {},\n          },\n          develop: {\n            env: options.app.dotenv?.variables ?? {},\n          },\n        },\n        capabilities: extension.configuration.capabilities,\n      }\n    }),\n  )\n\n  return {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    public_url: options.url,\n    port: options.port,\n    store: options.storeFqdn,\n    app: {\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      api_key: options.apiKey,\n    },\n    extensions: extensionsConfig,\n  }\n}\n\nexport async function getUIExtensionResourceURL(uiExtensionType: UIExtensionTypes, options: ExtensionConfigOptions) {\n  switch (uiExtensionType) {\n    case 'checkout_ui_extension':\n      return {url: options.cartUrl}\n    case 'checkout_post_purchase':\n    case 'pos_ui_extension':\n    case 'web_pixel_extension':\n      // This is a temporary workaround to avoid Admin crash when dev'ing multiple extensions\n      // Issue at shopify/web: https://github.com/Shopify/web/blob/main/app/components/Extensions/hooks/useResourceUrlQuery.ts#L15-L37\n      return {url: 'invalid_url'}\n    case 'product_subscription':\n      return {url: options.subscriptionProductUrl}\n  }\n}\n\nexport function getUIExtensionSurface(uiExtensionType: UIExtensionTypes) {\n  switch (uiExtensionType) {\n    case 'checkout_ui_extension':\n      return 'checkout'\n    case 'checkout_post_purchase':\n      return 'post_purchase'\n    case 'pos_ui_extension':\n      return 'pos'\n    case 'product_subscription':\n      return 'admin'\n    case 'web_pixel_extension':\n      // This value is mandatory but is not yet defined for web_pixel\n      return 'unknown'\n  }\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,mBAAA,GAAsB,CAAC,SAAsB,KAAA;AACjD,EAAA,OAAO,IAAI,KAAA,CAAM,GACf,CAAA,CAAA,6CAAA,EAAgD,aAChD,qDACF,CAAA,CAAA;AACF,CAAA,CAAA;AAqBA,eAAA,eAAA,CAAsC,OAAmD,EAAA;AACvF,EAAM,MAAA,gBAAA,GAAmB,MAAM,OAAQ,CAAA,GAAA,CACrC,QAAQ,UAAW,CAAA,GAAA,CAAI,OAAO,SAAc,KAAA;AAC1C,IAAA,MAAM,WAAW,MAAM,6BAAA,CAA8B,UAAU,aAAc,CAAA,IAAA,EAAM,QAAQ,GAAG,CAAA,CAAA;AAC9F,IAAA,IAAI,QAAa,KAAA,WAAA;AAAa,MAAM,MAAA,mBAAA,CAAoB,SAAU,CAAA,aAAA,CAAc,IAAI,CAAA,CAAA;AACpF,IAAO,OAAA;AAAA,MACL,MAAM,SAAU,CAAA,OAAA;AAAA,MAChB,KAAA,EAAO,UAAU,aAAc,CAAA,IAAA;AAAA,MAC/B,IAAA,EAAM,CAAG,EAAA,SAAA,CAAU,aAAc,CAAA,IAAA,CAAA,CAAA;AAAA,MACjC,UAAA,EAAY,UAAU,aAAc,CAAA,UAAA;AAAA,MAEpC,gBAAkB,EAAA,SAAA,CAAU,aAAc,CAAA,eAAA,IAAmB,EAAC;AAAA,MAE9D,eAAA,EAAiB,MAAM,qBAAsB,EAAA;AAAA,MAC7C,OAAS,EAAA,qBAAA,CAAsB,SAAU,CAAA,aAAA,CAAc,IAAI,CAAA;AAAA,MAC3D,SAAS,QAAU,EAAA,OAAA;AAAA,MACnB,WAAa,EAAA;AAAA,QAEX,UAAU,IAAK,CAAA,QAAA,CAAS,QAAQ,GAAI,CAAA,SAAA,EAAW,UAAU,SAAS,CAAA;AAAA,QAElE,SAAW,EAAA,OAAA,CAAQ,cACf,GAAA,IAAA,CAAK,SAAS,SAAU,CAAA,SAAA,EAAW,OAAQ,CAAA,cAAc,IACzD,IAAK,CAAA,QAAA,CAAS,SAAU,CAAA,SAAA,EAAW,UAAU,cAAc,CAAA;AAAA,QAC/D,OAAS,EAAA;AAAA,UACP,MAAM,IAAK,CAAA,QAAA,CAAS,SAAU,CAAA,SAAA,EAAW,UAAU,mBAAmB,CAAA;AAAA,SACxE;AAAA,QACA,QAAA;AAAA,QACA,QAAA,EAAU,QAAQ,kBACd,GAAA,MAAM,0BAA0B,SAAU,CAAA,aAAA,CAAc,IAAM,EAAA,OAAO,CACrE,GAAA,IAAA;AAAA,QACJ,KAAO,EAAA;AAAA,UACL,GAAK,EAAA,OAAA,CAAQ,GAAI,CAAA,MAAA,EAAQ,aAAa,EAAC;AAAA,SACzC;AAAA,QACA,OAAS,EAAA;AAAA,UACP,GAAK,EAAA,OAAA,CAAQ,GAAI,CAAA,MAAA,EAAQ,aAAa,EAAC;AAAA,SACzC;AAAA,OACF;AAAA,MACA,YAAA,EAAc,UAAU,aAAc,CAAA,YAAA;AAAA,KACxC,CAAA;AAAA,GACD,CACH,CAAA,CAAA;AAEA,EAAO,OAAA;AAAA,IAEL,YAAY,OAAQ,CAAA,GAAA;AAAA,IACpB,MAAM,OAAQ,CAAA,IAAA;AAAA,IACd,OAAO,OAAQ,CAAA,SAAA;AAAA,IACf,GAAK,EAAA;AAAA,MAEH,SAAS,OAAQ,CAAA,MAAA;AAAA,KACnB;AAAA,IACA,UAAY,EAAA,gBAAA;AAAA,GACd,CAAA;AACF,CAAA;AAEA,eAAA,yBAAA,CAAgD,iBAAmC,OAAiC,EAAA;AAClH,EAAQ,QAAA,eAAA;AAAA,IACD,KAAA,uBAAA;AACH,MAAO,OAAA,EAAC,GAAK,EAAA,OAAA,CAAQ,OAAO,EAAA,CAAA;AAAA,IACzB,KAAA,wBAAA,CAAA;AAAA,IACA,KAAA,kBAAA,CAAA;AAAA,IACA,KAAA,qBAAA;AAGH,MAAO,OAAA,EAAC,KAAK,aAAa,EAAA,CAAA;AAAA,IACvB,KAAA,sBAAA;AACH,MAAO,OAAA,EAAC,GAAK,EAAA,OAAA,CAAQ,sBAAsB,EAAA,CAAA;AAAA,GAAA;AAEjD,CAAA;AAEO,SAAA,qBAAA,CAA+B,eAAmC,EAAA;AACvE,EAAQ,QAAA,eAAA;AAAA,IACD,KAAA,uBAAA;AACH,MAAO,OAAA,UAAA,CAAA;AAAA,IACJ,KAAA,wBAAA;AACH,MAAO,OAAA,eAAA,CAAA;AAAA,IACJ,KAAA,kBAAA;AACH,MAAO,OAAA,KAAA,CAAA;AAAA,IACJ,KAAA,sBAAA;AACH,MAAO,OAAA,OAAA,CAAA;AAAA,IACJ,KAAA,qBAAA;AAEH,MAAO,OAAA,SAAA,CAAA;AAAA,GAAA;AAEb;;;;"}